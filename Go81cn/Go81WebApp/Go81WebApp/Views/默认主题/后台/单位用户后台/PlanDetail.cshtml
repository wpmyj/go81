@model IEnumerable<Go81WebApp.Models.数据模型.需求计划模型.需求计划链接>
@using Go81WebApp.Models.数据模型
@using Go81WebApp.Models.数据模型.需求计划模型
@{
    ViewBag.Title = "需求计划审核";
    Layout = "_Back_IntranetLayout.cshtml";
}
<style>
    .out_box {
        display: none;
    }

    .out_box_infirst {
        position: fixed;
        z-index: 5;
        top: 0px;
        left: 0px;
        text-align: center;
        right: 0;
        bottom: 0px;
        background-color: black;
        opacity: 0.5;
        -moz-opacity: 0.5;
        filter: alpha(opacity=50);
        height: 100%;
        width: 100%;
        border: 1px solid green;
        box-shadow: 0px 0px 10px gray;
        -webkit-box-shadow: 0px 0px 10px gray;
        -moz-box-shadow: 0px 0px 10px gray;
    }

    .out_box_insecond {
        position: fixed;
        width: 100%;
        height: 80%;
        left: 0px;
        z-index: 20;
        top: 3%;
    }

    .out_box_insecond_child {
        width: 600px;
        position: relative;
        margin: 0px auto;
        z-index: 100;
        background-color: white;
        border: 1px solid red;
    }

    .close_outbox {
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        background-color: red;
        font-size: 30px;
        color: white;
        float: right;
        cursor: pointer;
    }

    li {
        line-height: 30px;
    }

    td ul {
        display: none;
    }

    .container ul li {
        background-color: #FCF6D4;
    }

    .name {
        cursor: pointer;
    }

        .name:hover {
            cursor: pointer;
            text-decoration: underline;
        }

    .icon {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: url(/Images/tree_icons.png) 0px -5px;
    }

    li input {
        margin-left: 30px;
    }

    .addbt {
        display: inline-block;
        width: 60px;
        height: 25px;
        background-color: #00D027;
        text-align: center;
        line-height: 25px;
        border: none;
        font-size: 14px;
    }

    .nopass {
        background-color: #808080;
    }

    .notice {
        display: none;
        position: absolute;
        z-index: 20;
        width: 160px;
        height: auto;
        padding: 5px;
        border: 1px solid red;
        background-color: white;
        opacity: 0.95;
        filter: alpha(opacity=90);
        color: black;
        right: 125px;
        text-indent: 2em;
        font-size: 13px;
        text-align: left;
        line-height: 20px;
        word-break: break-all;
    }

    #backoff {
    }

    table tr td img {
        cursor: pointer;
    }

    table {
        border: 1px solid #C2C2C2;
        border-top: none;
        border-left: none;
    }

    th {
        border: 1px solid #C2C2C2;
        border-bottom: none;
        border-right: none;
        line-height: 30px;
    }

    td {
        border: 1px solid #C2C2C2;
        border-bottom: none;
        border-right: none;
        line-height: 30px;
    }

    .sbt {
        background-color: #BCBCBC;
        color: #ffffff;
    }

    .trodd {
        background-color: #ffffff;
    }

    .treven {
        background-color: #EBEBEB;
    }

    .progressBt {
        height: 40px;
        margin-bottom: 5px;
        background-color: #FF4B4B;
        color: #fff;
        border: none;
        float: right;
        margin-right: 10px;
        text-decoration: none;
        width: 150px;
        margin-top: 5px;
    }

    .listdetailtable {
        margin-top: 5px;
        border-top: 1px solid #999a96;
        border-left: 1px solid #999a96;
    }

        .listdetailtable tr:hover td {
            background: #ecf0d7;
        }


        .listdetailtable th {
            background-color: #c9cfad;
            font-size: 15px;
            height: 35px;
        }

        .listdetailtable td {
            padding: 5px;
            letter-spacing: 0;
        }
</style>
<script type="text/javascript" src="~/JS/My97DatePicker/calendar.js"></script>
<script type="text/javascript" src="~/JS/My97DatePicker/config.js"></script>
<script type="text/javascript" src="~/JS/My97DatePicker/WdatePicker.js"></script>
<div id="pdf0" class="out_box">
    <div class="out_box_infirst">
    </div>
    <div class="out_box_insecond">
        <div class="out_box_insecond_child">
            <div style="width:100%; height:auto;"><a class="close_outbox" id="close" lang="" title="关闭窗口" onclick="hidebox(this,'#pdf0')">×</a></div>
            <div style="width:600px; height:200px;overflow:hidden;">
                <div>
                    <div>
                        <div><div style="text-align:center; line-height:30px;">请填写不通过原因</div></div>
                        <table style="border:none;" id="container" width="99%">
                            <tr>
                                <td style="border:none;" align="right" valign="top">不通过原因：</td>
                                <td style="border:none;"><textarea id="reason" style="resize:none;width:400px; height:100px;"></textarea> </td>
                            </tr>
                        </table>
                        <div style="text-align:center; margin:0px auto;">
                            <input class="addbt" value="保存" id="save" alt="0" type="button" onclick="saveInfo(this)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="pdf1" class="out_box">
    <div class="out_box_infirst">
    </div>
    <div class="out_box_insecond">
        <div class="out_box_insecond_child">
            <div style="width:100%; height:auto;"><a class="close_outbox" id="close" lang="" title="关闭窗口" onclick="hidebox1('#pdf1')">×</a></div>
            <div style="width:600px; height:auto;overflow:hidden;">
                <div>
                    <div>
                        <div><div style="text-align:center; line-height:30px;">当前需求处理单位如下：</div></div>
                        <div id="progress">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="pdf2" class="out_box">
    <div class="out_box_infirst">
    </div>
    <div class="out_box_insecond">
        <div class="out_box_insecond_child" style="width:90%; height:500px; overflow-y:scroll;">
            <div style="width:100%; height:auto;"><a class="close_outbox" id="close" lang="" title="关闭窗口" onclick="hidebox(this,'#pdf2')">×</a></div>
            <div style="width:100%; height:auto;overflow:hidden;">
                <div>
                    <div>
                        <div><div style="text-align:center; line-height:30px;">请勾选你要发回的物资：</div></div>
                        <div id="items">

                        </div>
                        <div style="text-align:center;"><input style="margin-top:20px; color:white; background-color:gray;" id="sbt3" type="button" value="保存" class="addbt" onclick="$('#pdf2').hide()" /></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="pdf3" class="out_box">
    <div class="out_box_infirst">
    </div>
    <div class="out_box_insecond">
        <div class="out_box_insecond_child">
            <div style="width:100%; height:auto;"><a class="close_outbox" id="close" lang="" title="关闭窗口" onclick="hidebox1('#pdf3')">×</a></div>
            <div style="width:600px; height:200px;overflow:hidden;">
                <div>
                    <div>
                        <div><div style="text-align:center; line-height:30px;">请填写不通过原因</div></div>
                        <table style="border:none;" id="container" width="99%">
                            <tr>
                                <td style="border:none;" align="right" valign="top">不通过原因：</td>
                                <td style="border:none;"><textarea id="reason1" style="resize:none;width:400px; height:100px;"></textarea> </td>
                            </tr>
                        </table>
                        <div style="text-align:center; margin:0px auto;">
                            <input class="addbt" value="保存" id="save" alt="0" type="button" onclick="saveReason(this)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="pdf4" class="out_box">
    <div class="out_box_infirst">
    </div>
    <div class="out_box_insecond">
        <div class="out_box_insecond_child" style="width:790px">
            <div style="width:100%; height:auto;"><a class="close_outbox" id="close" lang="" title="关闭窗口" onclick="hidebox1('#pdf4')">×</a></div>
            <div style="width:790px;min-height:200px; max-height:500px; overflow:scroll;">
                <div>
                    <div style="padding-left:10px; padding-bottom:10px; font-size:14px;">
                        审核不通过原因：
                        <ol>
                            @foreach (var item in ViewData["reason"].ToString().Split(','))
                            {
                                if (!string.IsNullOrWhiteSpace(item))
                                {
                                    <li>@item</li>
                                }
                            }
                        </ol>
                        不通过物资如下：
                        <table width="99%" cellpadding="0" cellspacing="0">
                            <tr>
                                <th width="15%">所属需求</th>
                                <th width="10%">物资</th>
                                <th width="10%">规格型号</th>
                                <th width="10%">单位</th>
                                <th width="10%">单价(元)</th>
                                <th width="10%">数量</th>
                                <th width="5%">预算金额(元)</th>
                                <th width="10%">供应商</th>
                                <th width="10%">交货期限</th>
                                <th width="10%">采购方式</th>
                            </tr>
                            @foreach (var item in ViewData["mlist"] as List<需求计划物资链接>)
                            {
                                var unitinfomodel = item.需求计划物资数据.所属需求计划.需求计划数据;
                                var unitinfoname = unitinfomodel.需求计划标题;
                                var brxqlinq = unitinfomodel.并入需求计划链接.需求计划ID;
                                if (brxqlinq != -1)
                                {
                                    unitinfoname = Go81WebApp.Controllers.后台.单位用户后台Controller.getdgunitname(unitinfomodel.Id,(long)ViewData["userid"]);
                                }
                                
                                <tr>
                                    <td>@unitinfoname</td>
                                    <td>@item.需求计划物资数据.物资名称</td>
                                    <td>@item.需求计划物资数据.规格型号</td>
                                    <td>@item.需求计划物资数据.计量单位</td>
                                    <td>@item.需求计划物资数据.单价</td>
                                    <td>@item.需求计划物资数据.数量</td>
                                    <td>@item.需求计划物资数据.预算金额</td>
                                    <td>@item.需求计划物资数据.供应商名称</td>
                                    <td>@item.需求计划物资数据.交货期限.ToString("yyyy/MM/dd")</td>
                                    <td>@item.需求计划物资数据.建议采购方式</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="bg_outdiv">
    <div class="bg_outdiv_left">
        @Html.Action("LeftMenu", "布局")
    </div>
    <div style="width:940px;margin-bottom:50px;" class="bg_outdiv_right">
        <div class="gys_xttz_topbg">
            <div class="index_bottom_zb_top_title">未通过需求计划<a href="###" style="color:red;" onclick="$('#pdf4').show()">【查看原因】</a></div>
        </div>
        @{
            int i = 0;
            int j = 1;
        }
        <div class="gys_znxx_box" style="border:none;">
            <div>
                <table class="outtable" width="100%" cellpadding="0" cellspacing="0">
                    <tr><th width="5%" style="background-color:#DFD2D2;"></th><th style="background-color:#DFD2D2;" width="25%">需求计划标题</th><th style="background-color:#DFD2D2;" width="25%">单位名称</th><th style="background-color:#DFD2D2;" width="10%">联系人</th><th style="background-color:#DFD2D2;" width="10%">联系电话</th><th style="background-color:#DFD2D2;" width="5%">备注</th><th style="background-color:#DFD2D2;" width="20%">审批</th></tr>
                    @foreach (var item in Model)
                    {
                        if (i % 3 == 0 || i % 3 == 2)
                        {
                            <tr class="trodd">
                                <td style="border-top:2px solid #8F8E8E;" align="center">@*<input type="checkbox" disabled="disabled" class="check@(i)" id="check__@(item.需求计划数据.Id)" name="check" value="@item.需求计划数据.Id" />*@</td>
                                <td style="border-top:2px solid #8F8E8E;">
                                    @if (item.需求计划数据.物资列表.Count > 20)
                                    {
                                        <a href="/单位用户后台/Material?id=@item.需求计划数据.Id&page=1"></a>
                                    }
                                    else
                                    {
                                        <span class="icon"></span><a class="name" lang="0">@item.需求计划数据.需求计划标题</a>
                                    }
                                </td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.需求发起单位链接.用户数据.单位信息.单位名称</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.联系人</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.联系电话</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">
                                    @if (!string.IsNullOrWhiteSpace(item.需求计划数据.备注))
                                    {
                                        <img onmouseover="showNotice(this)" onmouseout="hideNotice(this)" src="~/Images/notice.png" style="width:20px;vertical-align:middle;" />
                                        <div class="notice">
                                            @item.需求计划数据.备注
                                        </div>
                                    }
                                </td>
                                @if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                                {
                                    <td style="border-top:2px solid #8F8E8E;" align="center"><input type="button" alt="@(i)" name="allpass" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" alt="@(i)" name="noallpass" value="不通过" class="addbt sbt" /></td>
                                }
                                else
                                {
                                    <td style="border-top:2px solid #8F8E8E;color:red;" align="center">已发回到原单位<input type="button" alt="@(i)" name="allpass" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none; display:none;" class="addbt" /><input style="display:none;" type="button" alt="@(i)" name="noallpass" value="不通过" class="addbt sbt" /></td>
                                }
                            </tr>
                            <tr>
                                <td align="left" style="display:none;" colspan="7">
                                    <table id="table__@(item.需求计划数据.Id)" class="trodd" style="border-right:none; border-bottom:none;" width="100%" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <th style="width:46px; border-left:none;">编号</th>
                                            <th>物资名称</th>
                                            <th>规格型号</th>
                                            <th>计量单位</th>
                                            <th>技术指标</th>
                                            <th>建议采购方式</th>
                                            <th>数量</th>
                                            <th>交货期限</th>
                                            <th style="width:45px;">备注</th>
                                            <th style="width:186px;"></th>
                                        </tr>
                                        @foreach (var m in item.需求计划数据.物资列表)
                                        {
                                            if (m.需求计划物资数据 != null)
                                            {
                                                <tr>
                                                    <td style="text-align:center; border-left:none;">@j</td>
                                                    <td align="center" style="padding-left:5px;">@m.需求计划物资数据.物资名称</td>
                                                    <td align="center">@m.需求计划物资数据.规格型号</td>
                                                    <td align="center">@m.需求计划物资数据.计量单位</td>
                                                    <td align="center">@m.需求计划物资数据.技术指标</td>
                                                    <td align="center">@m.需求计划物资数据.建议采购方式</td>
                                                    <td align="center">@m.需求计划物资数据.数量</td>
                                                    <td align="center">@m.需求计划物资数据.交货期限.ToString("yyyy/MM/dd")</td>
                                                    <td style="text-align:center;">
                                                        @if (!string.IsNullOrWhiteSpace(m.需求计划物资数据.备注))
                                                        {
                                                            <img onmouseover="showNotice(this)" onmouseout="hideNotice(this)" style="width:20px; vertical-align:middle;" src="~/Images/notice.png" />
                                                            <div class="notice">
                                                                @m.需求计划物资数据.备注
                                                            </div>
                                                        }
                                                    </td>
                                                    <td style="text-align:center;">
                                                        @if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                                                        {
                                                            if (m.需求计划物资数据.来源合并项.Count != 0)
                                                            {
                                                                <input type="button" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" name="nopass" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="1" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                            }
                                                            else
                                                            {
                                                                <input type="button" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" name="nopass" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="0" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <input type="button" style="display:none;" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input style="display:none;" type="button" name="nopass" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="0" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                            j++;
                                        }
                                    </table>
                                </td>
                            </tr>
                            if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                            {
                                <tr class="trodd"><td colspan="7" style="height:80px;"><div id="backoff@(i)"><form action="/单位用户后台/passOut" method="post"><input type="submit" disabled="disabled" style='height:40px; margin-bottom:5px; background-color:#C9C9C9; color:#fff; border:none; float:right; margin-right:10px; text-decoration:none; width:150px; margin-top:5px;' value="发回需求提报单位" /><input type="hidden" value="@item.需求计划数据.Id" name="id" id="id@(i)" alt="@(i)" /><input type="hidden" name="main" value="" alt="@(i)" /><input type="hidden" class="r" value="" name="back" alt="@(i)" /></form><input type="button" class="progressBt" alt="@item.需求计划数据.Id" value="查看审核进度" /></div></td></tr>
                            }
                            else
                            {
                                <tr class="trodd" style="display:none;"><td colspan="7" style="height:80px;"><div id="backoff@(i)"><form action="/单位用户后台/passOut" method="post"><input type="submit" disabled="disabled" style='height:40px; margin-bottom:5px; background-color:#C9C9C9; color:#fff; border:none; float:right; margin-right:10px; text-decoration:none; width:150px; margin-top:5px;' value="发回需求提报单位" /><input type="hidden" value="@item.需求计划数据.Id" name="id" id="id@(i)" alt="@(i)" /><input type="hidden" name="main" value="" alt="@(i)" /><input type="hidden" class="r" value="" name="back" alt="@(i)" /></form><input type="button" class="progressBt" alt="@item.需求计划数据.Id" value="查看审核进度" /></div></td></tr>
                            }
                            i++;
                            j = 1;
                        }
                        else if (i % 3 == 1)
                        {
                            <tr class="treven">
                                <td style="border-top:2px solid #8F8E8E;" align="center">@*<input type="checkbox" disabled="disabled" class="check@(i)" id="check__@(item.需求计划数据.Id)" name="check" value="@item.需求计划数据.Id" />*@</td>
                                <td style="border-top:2px solid #8F8E8E;">
                                    @if (item.需求计划数据.物资列表.Count > 20)
                                    {
                                        <a href="/单位用户后台/Material?id=@item.需求计划数据.Id&page=1"></a>
                                    }
                                    else
                                    {
                                        <span class="icon"></span><a class="name" lang="0">@item.需求计划数据.需求计划标题</a>
                                    }
                                </td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.需求发起单位链接.用户数据.单位信息.单位名称</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.联系人</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">@item.需求计划数据.联系电话</td>
                                <td style="border-top:2px solid #8F8E8E;" align="center">
                                    @if (!string.IsNullOrWhiteSpace(item.需求计划数据.备注))
                                    {
                                        <img onmouseover="showNotice(this)" onmouseout="hideNotice(this)" src="~/Images/notice.png" style="width:20px;vertical-align:middle;" />
                                        <div class="notice">
                                            @item.需求计划数据.备注
                                        </div>
                                    }
                                </td>
                                @if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                                {
                                    <td style="border-top:2px solid #8F8E8E;" align="center"><input type="button" alt="@(i)" name="allpass" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" name="noallpass" alt="@(i)" lang="@item.需求计划数据.Id" value="不通过" class="addbt sbt" /></td>
                                }
                                else
                                {
                                    <td style="border-top:2px solid #8F8E8E;color:red;" align="center">已发回到原单位<input type="button" alt="@(i)" name="allpass" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;display:none;" class="addbt" /><input type="button" name="noallpass" style="display:none;" alt="@(i)" lang="@item.需求计划数据.Id" value="不通过" class="addbt sbt" /></td>
                                }
                            </tr>
                            <tr>
                                <td align="left" style="display:none;" colspan="7">
                                    <table id="table__@(item.需求计划数据.Id)" class="treven" style="border-right:none; border-bottom:none;" width="100%" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <th style="width:46px; border-left:none;">编号</th>
                                            <th>物资名称</th>
                                            <th>规格型号</th>
                                            <th>计量单位</th>
                                            <th>技术指标</th>
                                            <th>建议采购方式</th>
                                            <th>数量</th>
                                            <th>交货期限</th>
                                            <th style="width:45px;">备注</th>
                                            <th style="width:186px;"></th>
                                        </tr>
                                        @foreach (var m in item.需求计划数据.物资列表)
                                        {
                                            if (m.需求计划物资数据 != null)
                                            {
                                                <tr>
                                                    <td style="text-align:center; border-left:none;">@j</td>
                                                    <td align="center" style="padding-left:5px;">@m.需求计划物资数据.物资名称</td>
                                                    <td align="center">@m.需求计划物资数据.规格型号</td>
                                                    <td align="center">@m.需求计划物资数据.计量单位</td>
                                                    <td align="center">@m.需求计划物资数据.技术指标</td>
                                                    <td align="center">@m.需求计划物资数据.建议采购方式</td>
                                                    <td align="center">@m.需求计划物资数据.数量</td>
                                                    <td align="center">@m.需求计划物资数据.交货期限.ToString("yyyy/MM/dd")</td>
                                                    <td style="text-align:center;">
                                                        @if (!string.IsNullOrWhiteSpace(m.需求计划物资数据.备注))
                                                        {
                                                            <img onmouseover="showNotice(this)" onmouseout="hideNotice(this)" style="width:20px; vertical-align:middle;" src="~/Images/notice.png" />
                                                            <div class="notice">
                                                                @m.需求计划物资数据.备注
                                                            </div>
                                                        }
                                                    </td>
                                                    <td style="text-align:center;">
                                                        @if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                                                        {
                                                            if (m.需求计划物资数据.来源合并项.Count != 0)
                                                            {
                                                                <input type="button" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" name="nopass" id="@m.需求计划物资数据.Id" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="1" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                            }
                                                            else
                                                            {
                                                                <input type="button" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none;" class="addbt" /><input type="button" name="nopass" id="@m.需求计划物资数据.Id" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="0" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <input type="button" id="@m.需求计划物资数据.Id" name="pass" alt="@(i)" lang="@item.需求计划数据.Id" value="通过" style="color:white;text-decoration:none; display:none;" class="addbt" /><input type="button" style="display:none;" name="nopass" id="@m.需求计划物资数据.Id" alt="@(i)" lang="@item.需求计划数据.Id" ms_item="0" id="@m.需求计划物资数据.Id" value="不通过" class="addbt sbt" />
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                            j++;
                                        }
                                    </table>
                                </td>
                            </tr>
                            if (item.需求计划数据.审核历史列表.Last().审核状态 != 审核状态.审核未通过)
                            {
                                <tr class="treven"><td colspan="7" style="height:80px;"><div id="backoff@(i)"><form action="/单位用户后台/passOut" method="post"><input type="submit" disabled="disabled" style='height:40px; margin-bottom:5px; background-color:#C9C9C9; color:#fff; border:none; float:right; margin-right:10px; text-decoration:none; width:150px; margin-top:5px;' value="发回需求提报单位" /><input type="hidden" value="@item.需求计划数据.Id" name="id" id="id@(i)" alt="@(i)" /><input type="hidden" name="main" value="" alt="@(i)" /><input type="hidden" class="r" value="" name="back" alt="@(i)" /></form><input type="button" class="progressBt" alt="@item.需求计划数据.Id" value="查看审核进度" /></div></td></tr>
                            }
                            else
                            {
                                <tr class="treven" style="display:none;"><td colspan="7" style="height:80px;"><div id="backoff@(i)"><form action="/单位用户后台/passOut" method="post"><input type="submit" disabled="disabled" style='height:40px; margin-bottom:5px; background-color:#C9C9C9; color:#fff; border:none; float:right; margin-right:10px; text-decoration:none; width:150px; margin-top:5px;' value="发回需求提报单位" /><input type="hidden" value="@item.需求计划数据.Id" name="id" id="id@(i)" alt="@(i)" /><input type="hidden" name="main" value="" alt="@(i)" /><input type="hidden" class="r" value="" name="back" alt="@(i)" /></form><input type="button" class="progressBt" alt="@item.需求计划数据.Id" value="查看审核进度" /></div></td></tr>
                            }
                            i++;
                            j = 1;
                        }
                    }
                    @if ((int)ViewData["Pagecount"] == 0)
                    {
                        <tr><td style="color:red; padding-left:10px;" colspan="5">所有的需求都已发回原单位</td></tr>
                    }
                </table>
            </div>
            <div class="gys_znxx_content_detailbox">
                @{
                    int Pagecount = int.Parse(ViewData["Pagecount"].ToString());
                    int CurrentPage = int.Parse(ViewData["CurrentPage"].ToString());
                    if (Pagecount <= 6)
                    {
                        for (int k = 1; k <= Pagecount; k++)
                        {
                            if (CurrentPage == k)
                            {
                                <a style="border:1px solid red;" href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                            }
                            else
                            {
                                <a href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                            }
                        }
                        if (Pagecount != 0)
                        {
                            <span>@(CurrentPage)/@(Pagecount) 页</span>
                        }
                    }
                    else
                    {
                        if (CurrentPage < 6)
                        {
                            if (CurrentPage != 1)
                            {
                                <a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(CurrentPage-1)">上一页</a>
                                for (int k = 1; k < 7; k++)
                                {
                                    if (CurrentPage == k)
                                    {
                                        <a style="border:1px solid red;" href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                    }
                                    else
                                    {
                                        <a href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                    }
                                }
                                <span>...</span><a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(Pagecount)">@Pagecount</a><a href="/单位用户后台/DemandCheck?id=@ViewData["id"]&&page=@(CurrentPage+1)">下一页</a>
                                <span>@(CurrentPage)/@(Pagecount) 页</span>
                            }
                            else
                            {
                                for (int k = 1; k < 7; k++)
                                {
                                    if (CurrentPage == i)
                                    {
                                        <a style="border:1px solid red;" href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                    }
                                    else
                                    {
                                        <a href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                    }
                                }
                                <span>...</span><a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(Pagecount)">@Pagecount</a><a href="/单位用户后台/DemandCheck?id=@ViewData["id"]&&page=@(CurrentPage+1)">下一页</a>
                                <span>@(CurrentPage)/@(Pagecount) 页</span>
                            }
                        }
                        else if (CurrentPage >= 6 && CurrentPage < Pagecount - 3)
                        {
                            <a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(CurrentPage-1)">上一页</a><a href="/单位用户后台/DemandCheck?id=@ViewData["id"]&&page=1">1</a><span>...</span>
                            for (int k = (CurrentPage - 4 + 1); k <= CurrentPage + 1; k++)
                            {
                                if (CurrentPage == i)
                                {
                                    <a style="border:1px solid red;" href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                }
                                else
                                {
                                    <a href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                }
                            }
                            <span>...</span><a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(Pagecount)">@Pagecount</a><a href="/单位用户后台/DemandCheck?id=@ViewData["id"]&&page=@(CurrentPage+1)">下一页</a>
                            <span>@(CurrentPage)/@(Pagecount) 页</span>
                        }
                        else if (CurrentPage >= Pagecount - 3)
                        {
                            <a href="/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@(CurrentPage-1)">上一页</a><a href="/单位用户后台/DemandCheck?id=@ViewData["id"]&&page=1">1</a><span>...</span>
                            for (int k = Pagecount - 6 + 1; k <= Pagecount; k++)
                            {
                                if (CurrentPage == i)
                                {
                                    <a style="border:1px solid red;" href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@k'>@k</a>
                                }
                                else
                                {
                                    <a href='/单位用户后台/PlanDetail?id=@ViewData["id"]&&page=@i'>@i</a>
                                }
                            }
                            <span>@(CurrentPage)/@(Pagecount) 页</span>
                        }
                    }
                }
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    $(".name").click(function () {
        $(this).parent("td").parent("tr").next("tr").children("td").toggle();
        var num = $(this).attr("lang");
        if (num == "0") {
            $(this).prev("span").css("background", "url(/Images/tree_icons.png) 0px -22px");
            $(this).attr("lang", "1");
        }
        else {
            $(this).prev("span").css("background", "url(/Images/tree_icons.png) 0px -5px");
            $(this).attr("lang", "0");
        }
    });
    var e1 = null;
    var e2 = null;
    var temId = "";
    var number = -1;//表示第几项需求
    var reason = "";//不通过原因
    function saveInfo(th) {
        var id = $(e2).attr("id");//物资Id
        reason += id + "," + $("#reason").val();
        var temp = "";
        var str = "";
        if ($("#reason").val() != "") {
            if ($(th).attr("alt") == "1") {//保存原因，alt判断原因类别：1、计划原因，2、物资原因
                var str = $("#reason").val();
                var elem = document.getElementsByName("main");
                elem.item(number).value = reason;
            }
            else if ($(th).attr("alt") == "2") {
                var elem = document.getElementsByName("back");
                var str = elem.item(number).value.split('|');
                for (var n = 0; n < str.length - 1; n++) {
                    if (str[n].split(',')[0] != reason.split(',')[0]) {
                        temp += str[n] + "|";
                    }
                }
                temp += reason + "|";
                elem.item(number).value = temp;
            }
            $("#pdf0").hide();
        }
        else {
            alert("请填写原因！");
        }
    }//#00D027：绿色;
    $("[name='allpass']").click(function () {
        var tr = $(this).parent("td").parent("tr");
        var tr1 = $(this).parent("td").parent("tr").next("tr");
        var tr2 = $(this).parent("td").parent("tr").next("tr").next("tr");
        var index = $(this).attr("alt");
        var exist = false;//判断是否还有未通过的物资和计划
        var num = 0;
        var elem0 = document.getElementsByName("back");
        var elem = document.getElementsByName("main");
        var element = document.getElementsByName("nopass");
        if (elem0.item(parseInt(index)).value != "") {
            exist = true;
        }
        if (exist) {
            alert("由于至少有一项物资没有通过，所以此项需求项不能通过！");
        }
        else {
            elem.item(parseInt(index)).value = "";
            $(this).css({ "background-color": "#00D027" });
            $(this).next(":input").css({ "background-color": "#BCBCBC" });
            var v = $(this).attr("lang");
            $.get('/单位用户后台/PassDemand', { id: v }, function (data) {
                if (data == "-1") {
                    alert("成功通过审核,您可以合并此项需求！");
                }
                else if (data == "1") {
                    alert("成功通过审核");
                    $(tr).remove();
                    $(tr1).remove();
                    $(tr2).remove();
                    if ($("table.outtable tr").length == 1) {
                        window.location = '/单位用户后台/PlanDetail?page=1';
                    }
                }
                else {
                    alert("审核失败！");
                }
            });
            $("#backoff" + index).find("[type='submit']").attr("disabled", "disabled").css("background-color", "#C9C9C9");
        }
    });
    $("[name='noallpass']").click(function () {//alt索引;
        var index = $(this).attr("alt");
        number = parseInt(index);
        e1 = $(this).prev(":input");
        e2 = $(this);
        $(this).css("background-color", "red");
        $("#pdf0").show();
        $("#backoff" + index).find("[type='submit']").removeAttr("disabled").css("background-color", "#FF4B4B");
        $("#save").attr("alt", "1");
        $(this).prev(":input").css({ "background-color": "#BCBCBC" });
        reason = "0,";
    });
    $("[name='noallpass']").mouseover(function () {
        var reason1 = "";
        var str = "";
        var index = $(this).attr("alt");
        var elem0 = document.getElementsByName("main");
        var elem1 = document.getElementsByName("back");
        for (var i = 0; i < elem0.length; i++) {
            if (elem0.item(i).alt == index) {
                if (elem0.item(i).value != "") {
                    reason1 += elem0.item(i).value.split(',')[1] + ",";
                }
            }
        }
        for (var n = 0; n < elem1.length; n++) {
            if (elem1.item(n).alt == index) {
                str = elem1.item(n).value;
            }
        }
        for (var m = 0; m < str.split('|').length - 1; m++) {
            reason1 += str.split('|')[m].split(',')[1] + ",";
        }
        if (reason1 != "") {
            $(this).parent("td").append("<div style='position: absolute;word-break:break-all;z-index: 20;width: 160px;height: auto;padding: 5px;border: 1px solid red;background-color: white;opacity: 0.9;filter: alpha(opacity=90);color: black;right:80px;text-indent: 2em;font-size: 13px;text-align: left;line-height: 20px;'>" + reason1 + "</div>");
        }
    });
    $("[name='noallpass']").mouseout(function () {
        $(this).parent("td").children("div").remove();
    });
    $("[name='nopass']").mouseover(function () {
        var index = $(this).attr("alt");
        var id = $(this).attr("id");
        var str = "";
        var elem = document.getElementsByName("back");
        for (var i = 0; i < elem.length; i++) {
            if (elem.item(i).alt == index) {
                str = elem.item(i).value;
            }
        }
        for (var n = 0; n < str.split('|').length - 1; n++) {
            var str1 = str.split('|')[n].split(',');
            if (id == str1[0]) {
                if (str1[1] != "") {
                    $(this).parent("td").append("<div style='position: absolute;word-break:break-all;z-index: 20;width: 160px;height: auto;padding: 5px;border: 1px solid red;background-color: white;opacity: 0.9;filter: alpha(opacity=90);color: black;right:80px;text-indent: 2em;font-size: 13px;text-align: left;line-height: 20px;'>" + str1[1] + "</div>");
                    }
            }
        }
    });
    $("[name='nopass']").mouseout(function () {
        $(this).parent("td").children("div").remove();
    });
    $("[name='nopass']").click(function () {//alt索引;
        var sum = 0;
        var flag = $(this).attr("ms_item");
        var id = $(this).attr("id");//当前物资Id
        reason = id + "," + "" + "|";
        var tempValue = "";
        var index = $(this).attr("alt");
        number = parseInt(index);
        temId = $(this).attr("lang");//需求计划Id
        $("#id" + index).val(temId);
        if (flag == "1") {//flag为1表示该物资是合并后的物资，否则是未合并的物资
            getdetail(id);
        }
        else {
            $("#pdf0").show();
        }
        e1 = $(this).prev(":input");
        e2 = $(this);
        $(this).css("background-color", "red");
        var elem = document.getElementsByName("noallpass");
        var element = document.getElementsByName("allpass");
        for (var i = 0; i < elem.length; i++) {
            if (parseInt(elem.item(i).alt) == parseInt(index)) {
                elem.item(i).style.backgroundColor = "red";
            }
        }
        for (var j = 0; j < element.length; j++) {
            if (parseInt(element.item(j).alt) == parseInt(index)) {
                element.item(j).style.backgroundColor = "#BCBCBC";
            }
        }
        $("#backoff" + index).find("[type='submit']").removeAttr("disabled").css("background-color", "#FF4B4B");
        //填写原因
        var num = $(this).attr("lang");//编号
        $("#reason").val("");
        $("#save").attr("alt", "2");
        $(this).prev(":input").css({ "background-color": "#BCBCBC" });
    });
    $("[name='pass']").click(function () {
        reason = "";
        var index = $(this).attr("alt");//索引
        var id = $(this).attr("id");//物资ID
        var tempStr = '';
        var count = 0;//记录不通过的数目
        $(this).css({ "background-color": "#00D027" });
        $(this).next(":input").css({ "background-color": "#BCBCBC" });
        var num = $(this).attr("lang");//需求ID
        var elem = document.getElementsByName("back");
        var elem1 = document.getElementsByName("main");
        var elem2 = document.getElementsByName("noallpass");
        var elem3 = document.getElementsByName("allpass");
        tempStr = elem.item(parseInt(index)).value;
        for (var i = 0; i < tempStr.split('|').length - 1; i++) {
            var str = tempStr.split('|')[i];
            if (str.split(',')[0] != id) {
                reason += str + "|";
            }
        }
        elem.item(parseInt(index)).value = reason;
        if (elem.item(parseInt(index)).value == "" && elem1.item(parseInt(index)).value == "") {
            elem2.item(parseInt(index)).style.backgroundColor = "#BCBCBC";
            elem3.item(parseInt(index)).style.backgroundColor = "#00D027";
            $("#backoff" + index).find("[type='submit']").attr("disabled", "disabled").css("background-color", "#C9C9C9");
        }
    });
    $("table tr:last").css({ "border-bottom": "1px solid gray" });
    function showNotice(th) {
        $(th).next("div.notice").show();
    }
    function hideNotice(th) {
        $(th).next("div.notice").hide();
    }
    function showBox(th, fm) {
        var id = $(th).attr("lang");
        $("#nid").val(id);
        $(fm).show();
    }
    function hidebox(th, fm) {//alt:索引
        var index = $(e1).attr("alt");
        var id = $(e2).attr("id");
        $(e1).css("background-color", "#00D027");
        var elem0 = document.getElementsByName("back");
        var tempStr = "";
        tempStr = elem0.item(number).value;
        var exist = false;
        for (var j = 0; j < tempStr.split('|').length - 1; j++) {
            if (tempStr.split('|')[j].split(',')[0] == id) {
                exist = true;
                break;
            }
        }
        if (!exist) {
            $(e2).css("background-color", "#BCBCBC");
        }
        var elem = document.getElementsByName("noallpass");
        var elem1 = document.getElementsByName("nopass");
        var elem2 = document.getElementsByName("allpass");
        var count = 0;
        for (var i = 0; i < elem1.length; i++) {
            if (elem1.item(i).alt == index && elem1.item(i).style.backgroundColor == "red") {
                count++;
            }
        }
        if (count == 0) {
            for (var i = 0; i < elem.length; i++) {
                if (elem.item(i).alt == index && elem.item(i).style.backgroundColor == "red") {
                    elem.item(i).style.backgroundColor = "#BCBCBC";
                    break;
                }
            }
            for (var i = 0; i < elem2.length; i++) {
                if (elem2.item(i).alt == index) {
                    elem2.item(i).style.backgroundColor = "#00D027";
                    break;
                }
            }
            $("#backoff" + index).find("[type='submit']").attr("disabled", "disabled").css("background-color", "#C9C9C9");
        }
        $("#reason").val("");
        $(fm).hide();
    }
    var checkbox = null;
    function hidebox1(fm) {
        $(checkbox).attr("checked", false);
        reason = "";
        $(fm).hide();
    }
    function checkExist() {
        var elem = document.getElementsByName("back");
        var elem1 = document.getElementsByName("checkbox");
        var str = elem.item(number).value;
        for (var i = 0; i < str.split('|').length - 1; i++) {
            for (var j = 0; j < elem1.length; j++) {
                if (elem1.item(j).value == str.split('|')[i].split(',')[0]) {
                    elem1.item(j).checked = true;
                }
            }
        }
    }
    $(".progressBt").click(function () {
        $("#pdf1").show();
        var d = $(this).attr("alt");
        $.get('/单位用户后台/History', { id: d }, function (data) {
            if (data.Data.length != 0) {
                var str = "<table width='90%' style='margin:20px auto;' cellpadding='0' cellspacing='0'><tr><th>审核单位</th><th>审核时间</th><th>审核结果</th></tr>";
                for (var i = 0; i < data.Data.length; i++) {
                    str += "<tr><td>" + data.Data[i].user + "</td><td>" + data.Data[i].time + "</td><td>" + data.Data[i].status + "</td></tr>";
                }
                str += "</table>";
                $("#progress").html(str);
            }
            else {
                $("#progress").html("<h3 style='color:red; text-align:center;'>暂时没有任何审核数据！</h3>");
            }
        });
    });
    function getdetail(idstr) {
        $.ajax({
            cache: false,
            async: false, // 太关键了，同步和异步的参数
            //dataType: 'json', type: 'post',
            type: 'POST',
            //url: "/专家抽选/SearchByCondition_Temp?" + tempparm,
            url: "/单位用户后台/DemandDetail",
            data: "id=" + idstr,
            success: function (data) {
                $("#items").html(data);
                $("#pdf2").show();
                checkExist();
            }
        });
    }
    function changeshow(obj) {
        var id = $(obj).attr("value");
        //alert(id);
        var flag = $(obj).attr("flag");
        if (flag == "0") {
            $(obj).attr("class", "tre_level1");
            $("#smdetail_" + id).next("tr").remove();
            $(obj).attr("flag", "1");
        } else {
            $(obj).attr("class", "tre_level2");
            $(obj).attr("flag", "0");
            $.ajax({
                cache: false,
                async: false,
                type: 'POST',
                url: "/单位用户后台/DemanCheck",
                data: "id=" + id,
                success: function (data) {
                    if (data != "0") {
                        var tablecontent = "<tr><td colspan='12'>" + data + "</td></tr>";
                        $("#smdetail_" + id).after(tablecontent);
                    }
                    checkExist();
                }
            });
        }
    }
    function saveReason(th) {
        if ($("#reason1").val() != "") {
            var temp = "";//保存临时的value值
            var str = "";
            var exist = false;
            reason += $("#reason1").val() + "|";
            $("#sbt3").removeAttr("disabled").css({ "background-color": "#00D027" });
            $("#pdf3").hide();
            var elem = document.getElementsByName("back");
            temp = elem.item(number).value;
            for (var j = 0; j < reason.split('|').length - 1; j++) {
                for (var i = 0; i < temp.split('|').length - 1; i++) {
                    if (reason.split('|')[j].split(',')[0] == temp.split('|')[i].split(',')[0]) {
                        exist = true;
                        break;
                    }
                }
                if (!exist) {
                    str += reason.split('|')[j] + "|";
                }
            }
            elem.item(number).value += str;
            alert(reason);
            alert(elem.item(number).value);
            reason = "";
        }
        else {
            alert("请填写原因");
        }
    }
    function checkthis(th) {
        checkbox = th;
        if (th.checked) {
            reason += $(th).val() + ",";
            $("#pdf3").show();
        }
        else {
            var elem = document.getElementsByName("back");
            var str = elem.item(number).value;
            var temp = "";//保存临时值
            for (var i = 0; i < str.split('|').length - 1; i++) {
                if (str.split('|')[i].split(',')[0] != th.value) {
                    temp += str.split('|')[i] + "|";
                }
            }
        }
        elem.item(number).value = temp;
        alert(elem.item(number).value);
    }
</script>